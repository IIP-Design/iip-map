const exportDataBtn=document.getElementById("iip-map-export");function getMapProjectData(){let e={action:"export_data_ajax",map_id:iip_map_params.map_data_id,security:iip_map_params.export_nonce};jQuery.ajax({type:"post",url:iip_map_params.ajax_url,data:e,success:function(){console.log("Download worked!")},error:function(e,t,s){console.log("Failed due to "+t+"! \n"+s)}})}exportDataBtn.addEventListener("click",getMapProjectData);let googleKey=iip_map_params.google_api_key,mapId=iip_map_params.map_data_id,venueField=iip_map_params.venue_field,addressField=iip_map_params.address_field,cityField=iip_map_params.city_field,regionField=iip_map_params.region_field,countryField=iip_map_params.country_field,hostField=iip_map_params.host_field,eventField=iip_map_params.event_field,descField=iip_map_params.desc_field,dateField=iip_map_params.date_field,timeField=iip_map_params.time_field,durationField=iip_map_params.duration_field,topicField=iip_map_params.topic_field,contactField=iip_map_params.contact_field,onBatch=0,dataArray=[],responsesArray=[];document.addEventListener("DOMContentLoaded",function(){const e=document.createElement("script");e.type="text/javascript",e.src="https://maps.googleapis.com/maps/api/js?key="+googleKey,document.getElementsByTagName("head")[0].appendChild(e)});const geocodeBtn=document.getElementById("iip-map-geocode");function getScreendoorData(){let e=screendoorEndpoint+"/responses?per_page=10&status="+iip_map_params.trigger_status+screendoorKey,t=new XMLHttpRequest;t.open("GET",e),t.responseType="json",t.send(),t.onload=function(){let e=t.response;statusDisplay("Call to Screendoor API: "+t.statusText),geocodeAddress(e)}}function geocodeAddress(e){let t=e.length;statusDisplay("Returned <b>"+t+" results</b> with status "+iip_map_params.trigger_status);let s=Promise.resolve();let a=Math.floor(t/20),o=t%20;e.forEach(function(e){s=s.then(function(){let t=e.responses[addressField],s=e.responses[cityField],n=e.responses[regionField],r=e.responses[countryField],i=e.responses[eventField],p=e.id,d=t+", "+s+", "+r,l=s+", "+r,c={};const u=new google.maps.Geocoder;return u.geocode({address:d},function(d,m){if(statusDisplay("Google geocoding status for < "+i+" > : "+m),"OK"===m){let l=d[0].geometry.location.lat(),u=d[0].geometry.location.lng();c={map_id:mapId,venue_name:e.responses[venueField],venue_address:t,venue_city:s,venue_region:n,venue_country:r,lat:l,lng:u,host_name:e.responses[hostField],event_name:i,event_desc:e.responses[descField],event_date:e.responses[dateField],event_time:e.responses[timeField],event_duration:e.responses[durationField],event_topic:e.responses[topicField],contact:e.responses[contactField]},statusDisplay("Queuing results..."),batchResponses(c,p,20,a,o)}else"ZERO_RESULTS"===m?u.geocode({address:l},function(d,l){if(statusDisplay("Address not valid. Attempting to geocode fallback address for < "+i+" >"),"OK"===l){let l=d[0].geometry.location.lat(),u=d[0].geometry.location.lng();c={map_id:mapId,venue_name:e.responses[venueField],venue_address:t,venue_city:s,venue_region:n,venue_country:r,lat:l,lng:u,host_name:e.responses[hostField],event_name:i,event_desc:e.responses[descField],event_date:e.responses[dateField],event_time:e.responses[timeField],event_duration:e.responses[durationField],event_topic:e.responses[topicField],contact:e.responses[contactField]},statusDisplay("Queuing fallback results..."),batchResponses(c,p,20,a,o)}else statusDisplay(l+": Cannot map this event - < "+i+" >")}):statusDisplay(m+": Cannot map this event - < "+i+" >")}),new Promise(function(e){setTimeout(e,1e3)})})})}function batchResponses(e,t,s,a,o){onBatch<a?(dataArray.push(e),responsesArray.push(t),dataArray.length===s&&(statusDisplay("<b>SAVING "+s+" results...</b>"),populateSQLTable(dataArray,responsesArray),dataArray=[],responsesArray=[],onBatch++)):(dataArray.push(e),responsesArray.push(t),dataArray.length===o&&(statusDisplay("<b>SAVING "+o+" results...</b>"),populateSQLTable(dataArray,responsesArray),dataArray=[],responsesArray=[],onBatch=0))}function populateSQLTable(e,t){let s=t.length;jQuery.ajax({type:"post",dataType:"json",url:iip_map_params.ajax_url,data:{action:"map_ajax",data:e,security:iip_map_params.geocode_nonce},statusCode:{200:function(){statusDisplay("Status 200: <b>"+e.length+" events successfully saved</b>: < "+e.map(e=>e.event_name).join(", ")+" >"),statusDisplay("Updating Screendoor statuses..."),updateScreendoorStatus(t,s)}},error:function(t){statusDisplay("Status: <b>Error "+t.status+"</b> - "+t.statusText+". Could not save. "+e.length+" events: < "+e.map(e=>e.event_name).join(", ")+" >")}})}function updateScreendoorStatus(e,t){let s=iip_map_params.complete_status,a=0,o=0;e.forEach(function(e){let n=screendoorEndpoint+"/responses/"+e+"?"+screendoorKey;jQuery.ajax({type:"put",dataType:"json",url:n,data:{status:s},statusCode:{200:function(){a++,++o===t&&(reportStatusResults(a,s),o=0)}},error:function(n){statusDisplay("<b>ERROR "+n.status+"</b> - "+n.statusText+". Could not update Screendoor status for response #"+e),++o===t&&(reportStatusResults(a,s),o=0)}})})}function reportStatusResults(e,t){statusDisplay("Successfully updated "+e+" Screendoor responses to status < "+t+" >")}function statusDisplay(e){if("string"!=typeof e)throw new Error("statusDisplay(): argument must be a string");$("#geocoder-return").append(e+"<br />")}geocodeBtn.addEventListener("click",getScreendoorData);let screendoorEndpoint="https://screendoor.dobt.co/api/projects/"+iip_map_params.screendoor_project;const screendoorKey="&v=0&api_key="+iip_map_params.screendoor_api_key,getFieldsBtn=document.getElementById("iip-map-get-fields");function getScreendoorMeta(){getScreendoorFields(),getStatuses()}function getScreendoorFields(){let e=screendoorEndpoint+"/form?"+screendoorKey,t=new XMLHttpRequest;t.open("GET",e),t.responseType="json",t.send(),t.onload=function(){let e=t.response;t.statusText;populateScreendoorFields(e.field_data)}}function populateScreendoorFields(e){let t=document.querySelectorAll(".map-admin-project-info-select"),s=[];s.push("<option>- Select -</option>"),e.forEach(function(e){s.push("<option id='"+e.id+"' value='"+e.id+"'>"+e.label+"</option>")});let a=s.join("");t.forEach(function(e){e.innerHTML+=a})}function getStatuses(){let e=screendoorEndpoint+"/statuses?"+screendoorKey,t=new XMLHttpRequest;t.open("GET",e),t.responseType="json",t.send(),t.onload=function(){let e=t.response;t.statusText;populateStatuses(e)}}function populateStatuses(e){let t=document.getElementById("iip-map-geocoder-trigger"),s=document.getElementById("iip-map-geocoder-complete"),a=[];a.push("<option>- Select -</option>"),e.forEach(function(e){a.push("<option id='"+e.name+"' value='"+e.name+"'>"+e.name+"</option>")});let o=a.join("");t.innerHTML+=o,s.innerHTML+=o}getFieldsBtn.addEventListener("click",getScreendoorMeta);